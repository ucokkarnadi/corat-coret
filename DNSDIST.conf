addACL('0.0.0.0/0')
addACL('::/0')

webserver("0.0.0.0:8181")
setWebserverConfig({acl="103.80.80.0/22, 103.153.149.0/31", password="P@ssW0rd", apiKey="P@ssW0rd" })

addLocal("0.0.0.0:5353", {reusePort=true})
addLocal("0.0.0.0:5353", {reusePort=true})
addLocal("[::]:5353", {reusePort=true})
addLocal("[::]:5353", {reusePort=true})

addLocal("0.0.0.0", {reusePort=true})
addLocal("0.0.0.0", {reusePort=true})
addLocal("[::]", {reusePort=true})
addLocal("[::]", {reusePort=true})

newServer({address="[2400:4ec0::243]", name="JSN", qps=1000 })
newServer({address="[2400:4ec0::244]", name="JSN", qps=1000 })
newServer({address="[2400:4ec0::248]", name="JSN", qps=1000 })
newServer({address="[2400:4ec0::249]", name="JSN", qps=1000 })

addDOHLocal('0.0.0.0:443', '/usr/local/etc/letsencrypt/live/dnslb1.jsn.net.id/fullchain.pem', '/usr/local/etc/letsencrypt/live/dnslb1.jsn.net.id/privkey.pem', { '/dns-query' }, { doTCP=true, reusePort=true, tcpFastOpenSize=64, numberOfStoredSessions=20480000, sessionTimeout=20 })
addDOHLocal('0.0.0.0:443', '/usr/local/etc/letsencrypt/live/dnslb1.jsn.net.id/fullchain.pem', '/usr/local/etc/letsencrypt/live/dnslb1.jsn.net.id/privkey.pem', { '/dns-query' }, { doTCP=true, reusePort=true, tcpFastOpenSize=64, numberOfStoredSessions=20480000, sessionTimeout=20 })
addDOHLocal('[::]:443', '/usr/local/etc/letsencrypt/live/dnslb1.jsn.net.id/fullchain.pem', '/usr/local/etc/letsencrypt/live/dnslb1.jsn.net.id/privkey.pem', { '/dns-query' }, { doTCP=true, reusePort=true, tcpFastOpenSize=64, numberOfStoredSessions=20480000, sessionTimeout=20 })
addDOHLocal('[::]:443', '/usr/local/etc/letsencrypt/live/dnslb1.jsn.net.id/fullchain.pem', '/usr/local/etc/letsencrypt/live/dnslb1.jsn.net.id/privkey.pem', { '/dns-query' }, { doTCP=true, reusePort=true, tcpFastOpenSize=64, numberOfStoredSessions=20480000, sessionTimeout=20 })

addTLSLocal('0.0.0.0', '/usr/local/etc/letsencrypt/live/dnslb1.jsn.net.id/fullchain.pem', '/usr/local/etc/letsencrypt/live/dnslb1.jsn.net.id/privkey.pem' )
addTLSLocal('[::]', '/usr/local/etc/letsencrypt/live/dnslb1.jsn.net.id/fullchain.pem', '/usr/local/etc/letsencrypt/live/dnslb1.jsn.net.id/privkey.pem' )

-- addAction(AllRule(), LogAction("/var/log/dnsdist.log", false, true, false))

-- setServerPolicy(whashed)
-- setServerPolicy(leastOutstanding)
setServerPolicy(chashed)

controlSocket('127.0.0.1:5199')
setKey("apasajakeynya")

pc = newPacketCache( 100000, { maxTTL=86400, minTTL=0, temporaryFailureTTL=10, staleTTL=20, dontAge=false })
getPool(""):setCache(pc)


-- Prefix JSN
addAction(AndRule({makeRule("103.80.80.0/22"), MaxQPSIPRule(5000)}), DropAction())
addAction(AndRule({makeRule("103.153.148.0/23"), MaxQPSIPRule(5000)}), DropAction())
addAction(AndRule({makeRule("103.178.14.0/23"), MaxQPSIPRule(5000)}), DropAction())
addAction(AndRule({makeRule("103.18.232.0/23"), MaxQPSIPRule(5000)}), DropAction())
addAction(AndRule({makeRule("103.13.204.0/23"), MaxQPSIPRule(5000)}), DropAction())
addAction(AndRule({makeRule("2400:4ec0::/32"), MaxQPSIPRule(5000)}), DropAction())
addAction(AndRule({makeRule("2406:45c0::/32"), MaxQPSIPRule(5000)}), DropAction())
addAction(AndRule({makeRule("127.0.0.1/32"), MaxQPSIPRule(500000)}), DropAction())

-- Allow prefix umum
addAction(AndRule({makeRule("::/0"), MaxQPSIPRule(1500)}), DropAction())
addAction(AndRule({makeRule("0.0.0.0/0"), MaxQPSIPRule(1500)}), DropAction())

smn2 = newSuffixMatchNode()
smn2:add(newDNSName("10.in-addr.arpa."))
smn2:add(newDNSName("168.192.in-addr.arpa."))
smn2:add(newDNSName("16.172.in-addr.arpa."))
smn2:add(newDNSName("17.172.in-addr.arpa."))
smn2:add(newDNSName("18.172.in-addr.arpa."))
smn2:add(newDNSName("19.172.in-addr.arpa."))
smn2:add(newDNSName("20.172.in-addr.arpa."))
smn2:add(newDNSName("21.172.in-addr.arpa."))
smn2:add(newDNSName("22.172.in-addr.arpa."))
smn2:add(newDNSName("23.172.in-addr.arpa."))
smn2:add(newDNSName("24.172.in-addr.arpa."))
smn2:add(newDNSName("25.172.in-addr.arpa."))
smn2:add(newDNSName("26.172.in-addr.arpa."))
smn2:add(newDNSName("27.172.in-addr.arpa."))
smn2:add(newDNSName("28.172.in-addr.arpa."))
smn2:add(newDNSName("29.172.in-addr.arpa."))
smn2:add(newDNSName("30.172.in-addr.arpa."))
smn2:add(newDNSName("31.172.in-addr.arpa."))
addAction(AndRule({SuffixMatchNodeRule(smn2), QTypeRule(DNSQType.PTR)}), SpoofRawAction("\003JSN\010JaringanKU\000"))

smn3 = newSuffixMatchNode()
smn3:add(newDNSName('iover4u.net'))
smn3:add(newDNSName('wifi.tjkom.com'))
smn3:add(newDNSName('wifi.ptnat.net'))
smn3:add(newDNSName('forum.fancykeyapp.com'))
smn3:add(newDNSName('maribacaberita.com'))
smn3:add(newDNSName('yukbacaberita.com'))
smn3:add(newDNSName('yukbacaberita.com'))
smn3:add(newDNSName('itotolink.net'))
smn3:add(newDNSName('www.tendawifi.com'))
smn3:add(newDNSName('totolink'))
smn3:add(newDNSName('ru'))
smn3:add(newDNSName('br'))
smn3:add(newDNSName('gerbangakses.net.id'))
smn3:add(newDNSName('rndlabbankmandiri.co.id'))
smn3:add(newDNSName('aptilon.com'))
smn3:add(newDNSName('gemscool.com'))
smn3:add(newDNSName('qq.com'))
smn3:add(newDNSName('iemnet.xyz'))
smn3:add(newDNSName('ap.login'))
smn3:add(newDNSName('mytele.com.ua'))
smn3:add(newDNSName('adsco.re'))
smn3:add(newDNSName('lan'))
smn3:add(newDNSName('local'))
smn3:add(newDNSName('home'))

addAction( SuffixMatchNodeRule(smn3), RCodeAction(DNSRCode.NXDOMAIN))

addAction(RegexRule("^m[0-9]{1,2}\\.[a-z0-9]{7}\\.[a-z]{2,3}$"), RCodeAction(DNSRCode.NXDOMAIN))
